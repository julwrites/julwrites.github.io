<!DOCTYPE html>
  <html lang="en">
  <head>
    <link rel="stylesheet" href="/style.css">
    
    <link rel="preload" href="/elm.js" as="script">
    <link rel="modulepreload" href="/index.js">
    
    <script defer="defer" src="/elm.js" type="text/javascript"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script type="module">
import userInit from"/index.js";
let prefetchedPages=[window.location.pathname],initialLocationHash=document.location.hash.replace(/^#/,"");function loadContentAndInitializeApp(){let a=window.location.pathname.replace(/(w)$/,"$1/");a.endsWith("/")||(a+="/");const b=Elm.TemplateModulesBeta.init({flags:{secrets:null,baseUrl:document.baseURI,isPrerendering:!1,isDevServer:!1,isElmDebugMode:!1,contentJson:JSON.parse(document.getElementById("__ELM_PAGES_DATA__").innerHTML),userFlags:userInit.flags()}});return b.ports.toJsPort.subscribe(()=>{loadNamedAnchor()}),b}function loadNamedAnchor(){if(""!==initialLocationHash){const a=document.querySelector(`[name=${initialLocationHash}]`);a&&a.scrollIntoView()}}function prefetchIfNeeded(a){if(a.host===window.location.host&&!prefetchedPages.includes(a.pathname)){prefetchedPages.push(a.pathname),console.log("Preloading...",a.pathname);const b=document.createElement("link");b.setAttribute("as","fetch"),b.setAttribute("rel","prefetch"),b.setAttribute("href",origin+a.pathname+"/content.json"),document.head.appendChild(b)}}const appPromise=new Promise(function(a){document.addEventListener("DOMContentLoaded",()=>{a(loadContentAndInitializeApp())})});userInit.load(appPromise),"function"==typeof connect&&connect(function(a){appPromise.then(b=>{b.ports.fromJsPort.send({contentJson:a})})});const trigger_prefetch=b=>{const c=find_anchor(b.target);c&&c.href&&c.hasAttribute("elm-pages:prefetch")&&prefetchIfNeeded(c)};let mousemove_timeout;const handle_mousemove=a=>{clearTimeout(mousemove_timeout),mousemove_timeout=setTimeout(()=>{trigger_prefetch(a)},20)};addEventListener("touchstart",trigger_prefetch),addEventListener("mousemove",handle_mousemove);function find_anchor(a){for(;a&&"A"!==a.nodeName.toUpperCase();)a=a.parentNode;return a}
    </script>
    <title>tehj.io</title>
    <meta name="generator" content="elm-pages v2.1.10">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="canonical" href="https://tehj.io/projects/2022_01_07_Golang_Bot_Cloud_Run" />    <meta name="description" content="TODO" />    <meta property="og:image" content="TODO" />    <meta property="og:image:secure_url" content="TODO" />    <meta property="og:image:alt" content="elm-pages logo" />    <meta property="og:title" content="tehj.io" />    <meta property="og:url" content="https://tehj.io/projects/2022_01_07_Golang_Bot_Cloud_Run" />    <meta property="og:description" content="TODO" />    <meta property="og:site_name" content="tehj.io" />    <meta property="twitter:card" content="summary" />    <meta property="twitter:title" content="tehj.io" />    <meta property="twitter:description" content="TODO" />    <meta property="twitter:image" content="TODO" />    <meta property="twitter:image:alt" content="elm-pages logo" />    <meta property="og:type" content="website" />    <link rel="sitemap" type="application/xml" href="/sitemap.xml" />
    <script id="__ELM_PAGES_DATA__" type="application/json">{"staticData":{"1973487363":"{\"rawFile\":\"# Migrating my Golang Bot to Google Cloud Run\\n\\nPrior to this, I had hosted my Telegram Bot on Google Cloud App Engine, and this had worked decently well - for years, I might add - until recently I did a routine check on my bill statements and discovered that I had a $3 charge from Google. \\n\\nNow, $3 isn't a lot, and it wasn't a problem for me to pay for it, but the fact that my bot's usage of compute power had broken the free barrier for the first time in years was either a very happy thing, or a troubling one. \\n\\nTurns out, it was the latter. \\n\\nI was getting a failing request that would repeat every 5 minutes, and while this wasn't enough to bring down the service, it was certainly enough to cost more in terms of compute time. \\n\\nAfter some discussion with a friend, I decided that I should do two things:\\n1. Fix the failing request, which would prevent this repeated message issue\\n2. Migrate to Google Cloud Run, which would reduce cost if it did re-occur\\n\\n## 1. Go Modules\\n\\nMy last update to this repository had been a few years ago, when Go had not yet developed a mature package ecosystem (even now this seems contentious). \\n\\nBut since I wanted to containerize it, it was useful to also use a package management system rather than pulling the latest github repository of any dependency I wanted. If nothing else, this allowed me to selectively update dependencies, or freeze them to prevent any deployment surprises. \\n\\nA quick `go mod init` followed by `go mod tidy` sufficed.\\n\\n## 2. Containerization\\n\\nGoogle Cloud Run uses containers to spin up a serverless instance, which then dies after the request has been handled. As such, I needed to containerize my solution - i.e. Dockerize. \\n\\nUsing a template for a Go module deployment, I modified the necessary files and built the container with little issue. \\n\\nI had to do a little trick to include my secrets file into the image, which was just to copy the `secrets.yaml` from the build directory into the container, and then deploy the container. \\n\\nSince I never pushed the `secrets.yaml` to Github, this was technically pretty safe, and I was okay with this approach so far. \\n\\n## 3. Google Artifact Registry\\n\\nI didn't have GCloud CLI on my device, so I had to get that installed and set up. \\n\\n```\\ngcloud config set project ${PROJECT_NAME}\\n\\necho $CI_SERVICE_KEY > key.json\\n\\ngcloud auth activate-service-account \\\\\\n  $CI_SERVICE_ACCOUNT --key-file=key.json\\n  \\ngcloud auth configure-docker \\\\\\n  \\\"${ARTIFACT_REGISTRY_REGION}-docker.pkg.dev\\\" \\n```\\n\\n![Service_Accounts.png](../assets/blog/2022_01_07_Golang_Bot_Cloud_Run/Service_Accounts.png)\\n\\nThis wasn't too difficult. I had to create a service account on GCloud and prepare the key, and I was able to authenticate Docker on my machine against Google Artifact Registry. \\n\\nBuilding and pushing the container was also not difficult manually. \\n\\n```\\ndocker build -f Dockerfile -t $CONTAINER_IMAGE  .\\n\\ndocker push $CONTAINER_IMAGE\\n\\ngcloud run deploy $CLOUD_RUN_SERVICE_NAME \\\\\\n  --image $CONTAINER_IMAGE \\\\\\n  --region $CLOUD_RUN_SERVICE_REGION\\n```\\n\\nIt was pretty easy to verify these processes succeeded, just by checking the Artifact Registry and Cloud Run panels respectively. \\n\\n![Artifact_Registry.png](../assets/blog/2022_01_07_Golang_Bot_Cloud_Run/Artifact_Registry.png)\\n![Cloud_Run.png](../assets/blog/2022_01_07_Golang_Bot_Cloud_Run/Cloud_Run.png)\\n\\nUp to this point, I was able to manage quite decently, and the immediate issue was fixed within the day. \\n\\nI retired the old AppEngine version of the service, and moved on. \\n\\n## 4. CI/CD with Github Actions\\n\\nUp to this point I was able to ensure security by basically running this whole process only on an authenticated device; i.e. my laptop. I needed to authenticate Github Actions to do the same thing. \\n\\nI quickly discovered that Github Actions did not have the same idea of 'secure' that I did. It took me awhile and a lot of experimentation to figure that I not only needed to have the Service Account, but also...\\n\\n1. To set up GCloud Auth on the project\\n2. A step which I forgot, and which cost me a couple of days of debugging - to authenticate Docker with GCloud Auth\\n\\n![Github_Actions.png](../assets/blog/2022_01_07_Golang_Bot_Cloud_Run/Github_Actions.png)\\n\\nIn the process of debugging, I also went ahead and upgraded my security method to use Google Auth's Workload Identity Federation, following [this post](https://cloud.google.com/blog/products/identity-security/enabling-keyless-authentication-from-github-actions).\\n\\nOnce those were done, it was a pretty simple process to serialize the secrets from Github Actions into the docker container, and then to run the same steps as above from Github Actions. \\n\\n\"}"},"is404":false,"path":"projects/2022_01_07_Golang_Bot_Cloud_Run"}</script>
    </head>
    <body>
      <div data-url="" display="none"></div>
      <div class="font-size-20 bg-34-44-60-255 fc-255-255-255-255 ff-fira-sanssans-serif p-30 s e max-width-0 wf ui s e"><div><style>@media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {.s.r > .s { flex-basis: auto !important; } .s.r > .s.ctr { flex-basis: auto !important; }}
input[type="search"],
input[type="search"]::-webkit-search-decoration,
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-results-button,
input[type="search"]::-webkit-search-results-decoration {
  -webkit-appearance:none;
}

input[type=range] {
  -webkit-appearance: none; 
  background: transparent;
  position:absolute;
  left:0;
  top:0;
  z-index:10;
  width: 100%;
  outline: dashed 1px;
  height: 100%;
  opacity: 0;
}

input[type=range]::-moz-range-track {
    background: transparent;
    cursor: pointer;
}
input[type=range]::-ms-track {
    background: transparent;
    cursor: pointer;
}
input[type=range]::-webkit-slider-runnable-track {
    background: transparent;
    cursor: pointer;
}

input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    opacity: 0.5;
    width: 80px;
    height: 80px;
    background-color: black;
    border:none;
    border-radius: 5px;
}
input[type=range]::-moz-range-thumb {
    opacity: 0.5;
    width: 80px;
    height: 80px;
    background-color: black;
    border:none;
    border-radius: 5px;
}
input[type=range]::-ms-thumb {
    opacity: 0.5;
    width: 80px;
    height: 80px;
    background-color: black;
    border:none;
    border-radius: 5px;
}
input[type=range][orient=vertical]{
    writing-mode: bt-lr; /* IE */
    -webkit-appearance: slider-vertical;  /* WebKit */
}

.explain {
    border: 6px solid rgb(174, 121, 15) !important;
}
.explain > .s {
    border: 4px dashed rgb(0, 151, 167) !important;
}

.ctr {
    border: none !important;
}
.explain > .ctr > .s {
    border: 4px dashed rgb(0, 151, 167) !important;
}

html,body{height:100%;padding:0;margin:0;}.s.e.ic{display:block;}.s.e.ic.hf > img{max-height:100%;object-fit:cover;}.s.e.ic.wf > img{max-width:100%;object-fit:cover;}.s:focus{outline:none;}.ui{width:100%;height:auto;min-height:100%;z-index:0;}.ui.s.hf{height:100%;}.ui.s.hf > .hf{height:100%;}.ui > .fr.nb{position:fixed;z-index:20;}.nb{position:relative;border:none;display:flex;flex-direction:row;flex-basis:auto;}.nb.e{display:flex;flex-direction:column;white-space:pre;}.nb.e.hbh{z-index:0;}.nb.e.hbh > .bh{z-index:-1;}.nb.e.sbt > .t.hf{flex-grow:0;}.nb.e.sbt > .t.wf{align-self:auto !important;}.nb.e > .hc{height:auto;}.nb.e > .hf{flex-grow:100000;}.nb.e > .wf{width:100%;}.nb.e > .wfp{width:100%;}.nb.e > .wc{align-self:flex-start;}.nb.e.ct{justify-content:flex-start;}.nb.e > .s.at{margin-bottom:auto !important;margin-top:0 !important;}.nb.e.cb{justify-content:flex-end;}.nb.e > .s.ab{margin-top:auto !important;margin-bottom:0 !important;}.nb.e.cr{align-items:flex-end;}.nb.e > .s.ar{align-self:flex-end;}.nb.e.cl{align-items:flex-start;}.nb.e > .s.al{align-self:flex-start;}.nb.e.ccx{align-items:center;}.nb.e > .s.cx{align-self:center;}.nb.e.ccy > .s{margin-top:auto;margin-bottom:auto;}.nb.e > .s.cy{margin-top:auto !important;margin-bottom:auto !important;}.nb.a{position:absolute;bottom:100%;left:0;width:100%;z-index:20;margin:0 !important;pointer-events:none;}.nb.a > .hf{height:auto;}.nb.a > .wf{width:100%;}.nb.a > *{pointer-events:auto;}.nb.b{position:absolute;bottom:0;left:0;height:0;width:100%;z-index:20;margin:0 !important;pointer-events:none;}.nb.b > *{pointer-events:auto;}.nb.b > .hf{height:auto;}.nb.or{position:absolute;left:100%;top:0;height:100%;margin:0 !important;z-index:20;pointer-events:none;}.nb.or > *{pointer-events:auto;}.nb.ol{position:absolute;right:100%;top:0;height:100%;margin:0 !important;z-index:20;pointer-events:none;}.nb.ol > *{pointer-events:auto;}.nb.fr{position:absolute;width:100%;height:100%;left:0;top:0;margin:0 !important;pointer-events:none;}.nb.fr > *{pointer-events:auto;}.nb.bh{position:absolute;width:100%;height:100%;left:0;top:0;margin:0 !important;z-index:0;pointer-events:none;}.nb.bh > *{pointer-events:auto;}.s{position:relative;border:none;flex-shrink:0;display:flex;flex-direction:row;flex-basis:auto;resize:none;font-feature-settings:inherit;box-sizing:border-box;margin:0;padding:0;border-width:0;border-style:solid;font-size:inherit;color:inherit;font-family:inherit;line-height:1;font-weight:inherit;text-decoration:none;font-style:inherit;}.s.wrp{flex-wrap:wrap;}.s.notxt{-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;}.s.cptr{cursor:pointer;}.s.ctxt{cursor:text;}.s.ppe{pointer-events:none !important;}.s.cpe{pointer-events:auto !important;}.s.clr{opacity:0;}.s.oq{opacity:1;}.s.hvclr:hover{opacity:0;}.s.hvoq:hover{opacity:1;}.s.fcsclr:focus{opacity:0;}.s.fcsoq:focus{opacity:1;}.s.atvclr:active{opacity:0;}.s.atvoq:active{opacity:1;}.s.ts{transition:transform 160ms, opacity 160ms, filter 160ms, background-color 160ms, color 160ms, font-size 160ms;}.s.sb{overflow:auto;flex-shrink:1;}.s.sbx{overflow-x:auto;}.s.sbx.r{flex-shrink:1;}.s.sby{overflow-y:auto;}.s.sby.c{flex-shrink:1;}.s.sby.e{flex-shrink:1;}.s.cp{overflow:hidden;}.s.cpx{overflow-x:hidden;}.s.cpy{overflow-y:hidden;}.s.wc{width:auto;}.s.bn{border-width:0;}.s.bd{border-style:dashed;}.s.bdt{border-style:dotted;}.s.bs{border-style:solid;}.s.t{white-space:pre;display:inline-block;}.s.it{line-height:1.05;background:transparent;text-align:inherit;}.s.e{display:flex;flex-direction:column;white-space:pre;}.s.e.hbh{z-index:0;}.s.e.hbh > .bh{z-index:-1;}.s.e.sbt > .t.hf{flex-grow:0;}.s.e.sbt > .t.wf{align-self:auto !important;}.s.e > .hc{height:auto;}.s.e > .hf{flex-grow:100000;}.s.e > .wf{width:100%;}.s.e > .wfp{width:100%;}.s.e > .wc{align-self:flex-start;}.s.e.ct{justify-content:flex-start;}.s.e > .s.at{margin-bottom:auto !important;margin-top:0 !important;}.s.e.cb{justify-content:flex-end;}.s.e > .s.ab{margin-top:auto !important;margin-bottom:0 !important;}.s.e.cr{align-items:flex-end;}.s.e > .s.ar{align-self:flex-end;}.s.e.cl{align-items:flex-start;}.s.e > .s.al{align-self:flex-start;}.s.e.ccx{align-items:center;}.s.e > .s.cx{align-self:center;}.s.e.ccy > .s{margin-top:auto;margin-bottom:auto;}.s.e > .s.cy{margin-top:auto !important;margin-bottom:auto !important;}.s.r{display:flex;flex-direction:row;}.s.r > .s{flex-basis:0%;}.s.r > .s.we{flex-basis:auto;}.s.r > .s.lnk{flex-basis:auto;}.s.r > .hf{align-self:stretch !important;}.s.r > .hfp{align-self:stretch !important;}.s.r > .wf{flex-grow:100000;}.s.r > .ctr{flex-grow:0;flex-basis:auto;align-self:stretch;}.s.r > u:first-of-type.acr{flex-grow:1;}.s.r > s:first-of-type.accx{flex-grow:1;}.s.r > s:first-of-type.accx > .cx{margin-left:auto !important;}.s.r > s:last-of-type.accx{flex-grow:1;}.s.r > s:last-of-type.accx > .cx{margin-right:auto !important;}.s.r > s:only-of-type.accx{flex-grow:1;}.s.r > s:only-of-type.accx > .cy{margin-top:auto !important;margin-bottom:auto !important;}.s.r > s:last-of-type.accx ~ u{flex-grow:0;}.s.r > u:first-of-type.acr ~ s.accx{flex-grow:0;}.s.r.ct{align-items:flex-start;}.s.r > .s.at{align-self:flex-start;}.s.r.cb{align-items:flex-end;}.s.r > .s.ab{align-self:flex-end;}.s.r.cr{justify-content:flex-end;}.s.r.cl{justify-content:flex-start;}.s.r.ccx{justify-content:center;}.s.r.ccy{align-items:center;}.s.r > .s.cy{align-self:center;}.s.r.sev{justify-content:space-between;}.s.r.lbl{align-items:baseline;}.s.c{display:flex;flex-direction:column;}.s.c > .s{flex-basis:0px;min-height:min-content;}.s.c > .s.he{flex-basis:auto;}.s.c > .hf{flex-grow:100000;}.s.c > .wf{width:100%;}.s.c > .wfp{width:100%;}.s.c > .wc{align-self:flex-start;}.s.c > u:first-of-type.acb{flex-grow:1;}.s.c > s:first-of-type.accy{flex-grow:1;}.s.c > s:first-of-type.accy > .cy{margin-top:auto !important;margin-bottom:0 !important;}.s.c > s:last-of-type.accy{flex-grow:1;}.s.c > s:last-of-type.accy > .cy{margin-bottom:auto !important;margin-top:0 !important;}.s.c > s:only-of-type.accy{flex-grow:1;}.s.c > s:only-of-type.accy > .cy{margin-top:auto !important;margin-bottom:auto !important;}.s.c > s:last-of-type.accy ~ u{flex-grow:0;}.s.c > u:first-of-type.acb ~ s.accy{flex-grow:0;}.s.c.ct{justify-content:flex-start;}.s.c > .s.at{margin-bottom:auto;}.s.c.cb{justify-content:flex-end;}.s.c > .s.ab{margin-top:auto;}.s.c.cr{align-items:flex-end;}.s.c > .s.ar{align-self:flex-end;}.s.c.cl{align-items:flex-start;}.s.c > .s.al{align-self:flex-start;}.s.c.ccx{align-items:center;}.s.c > .s.cx{align-self:center;}.s.c.ccy{justify-content:center;}.s.c > .ctr{flex-grow:0;flex-basis:auto;width:100%;align-self:stretch !important;}.s.c.sev{justify-content:space-between;}.s.g{display:-ms-grid;}.s.g > .gp > .s{width:100%;}@supports (display:grid) {.s.g{display:grid;
}}.s.g > .s.at{justify-content:flex-start;}.s.g > .s.ab{justify-content:flex-end;}.s.g > .s.ar{align-items:flex-end;}.s.g > .s.al{align-items:flex-start;}.s.g > .s.cx{align-items:center;}.s.g > .s.cy{justify-content:center;}.s.pg{display:block;}.s.pg > .s:first-child{margin:0 !important;}.s.pg > .s.al:first-child + .s{margin:0 !important;}.s.pg > .s.ar:first-child + .s{margin:0 !important;}.s.pg > .s.ar{float:right;}.s.pg > .s.ar::after{content:"";display:table;clear:both;}.s.pg > .s.al{float:left;}.s.pg > .s.al::after{content:"";display:table;clear:both;}.s.iml{white-space:pre-wrap !important;height:100%;width:100%;background-color:transparent;}.s.implw.e{flex-basis:auto;}.s.imlp{white-space:pre-wrap !important;cursor:text;}.s.imlp > .imlf{white-space:pre-wrap !important;color:transparent;}.s.p{display:block;white-space:normal;overflow-wrap:break-word;}.s.p.hbh{z-index:0;}.s.p.hbh > .bh{z-index:-1;}.s.p .t{display:inline;white-space:normal;}.s.p .p{display:inline;}.s.p .p::after{content:none;}.s.p .p::before{content:none;}.s.p .e{display:inline;white-space:normal;}.s.p .e.we{display:inline-block;}.s.p .e.fr{display:flex;}.s.p .e.bh{display:flex;}.s.p .e.a{display:flex;}.s.p .e.b{display:flex;}.s.p .e.or{display:flex;}.s.p .e.ol{display:flex;}.s.p .e > .t{display:inline;white-space:normal;}.s.p > .r{display:inline;}.s.p > .c{display:inline-flex;}.s.p > .g{display:inline-grid;}.s.p > .s.ar{float:right;}.s.p > .s.al{float:left;}.s.hidden{display:none;}.s.w1{font-weight:100;}.s.w2{font-weight:200;}.s.w3{font-weight:300;}.s.w4{font-weight:400;}.s.w5{font-weight:500;}.s.w6{font-weight:600;}.s.w7{font-weight:700;}.s.w8{font-weight:800;}.s.w9{font-weight:900;}.s.i{font-style:italic;}.s.sk{text-decoration:line-through;}.s.u{text-decoration:underline;text-decoration-skip-ink:auto;text-decoration-skip:ink;}.s.u.sk{text-decoration:line-through underline;text-decoration-skip-ink:auto;text-decoration-skip:ink;}.s.tun{font-style:normal;}.s.tj{text-align:justify;}.s.tja{text-align:justify-all;}.s.tc{text-align:center;}.s.tr{text-align:right;}.s.tl{text-align:left;}.s.modal{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;}.border-0{border-width:0px;}.border-1{border-width:1px;}.border-2{border-width:2px;}.border-3{border-width:3px;}.border-4{border-width:4px;}.border-5{border-width:5px;}.border-6{border-width:6px;}.font-size-8{font-size:8px;}.font-size-9{font-size:9px;}.font-size-10{font-size:10px;}.font-size-11{font-size:11px;}.font-size-12{font-size:12px;}.font-size-13{font-size:13px;}.font-size-14{font-size:14px;}.font-size-15{font-size:15px;}.font-size-16{font-size:16px;}.font-size-17{font-size:17px;}.font-size-18{font-size:18px;}.font-size-19{font-size:19px;}.font-size-20{font-size:20px;}.font-size-21{font-size:21px;}.font-size-22{font-size:22px;}.font-size-23{font-size:23px;}.font-size-24{font-size:24px;}.font-size-25{font-size:25px;}.font-size-26{font-size:26px;}.font-size-27{font-size:27px;}.font-size-28{font-size:28px;}.font-size-29{font-size:29px;}.font-size-30{font-size:30px;}.font-size-31{font-size:31px;}.font-size-32{font-size:32px;}.p-0{padding:0px;}.p-1{padding:1px;}.p-2{padding:2px;}.p-3{padding:3px;}.p-4{padding:4px;}.p-5{padding:5px;}.p-6{padding:6px;}.p-7{padding:7px;}.p-8{padding:8px;}.p-9{padding:9px;}.p-10{padding:10px;}.p-11{padding:11px;}.p-12{padding:12px;}.p-13{padding:13px;}.p-14{padding:14px;}.p-15{padding:15px;}.p-16{padding:16px;}.p-17{padding:17px;}.p-18{padding:18px;}.p-19{padding:19px;}.p-20{padding:20px;}.p-21{padding:21px;}.p-22{padding:22px;}.p-23{padding:23px;}.p-24{padding:24px;}.v-smcp{font-variant:small-caps;}.v-smcp-off{font-variant:normal;}.v-zero{font-feature-settings:"zero";}.v-zero-off{font-feature-settings:"zero" 0;}.v-onum{font-feature-settings:"onum";}.v-onum-off{font-feature-settings:"onum" 0;}.v-liga{font-feature-settings:"liga";}.v-liga-off{font-feature-settings:"liga" 0;}.v-dlig{font-feature-settings:"dlig";}.v-dlig-off{font-feature-settings:"dlig" 0;}.v-ordn{font-feature-settings:"ordn";}.v-ordn-off{font-feature-settings:"ordn" 0;}.v-tnum{font-feature-settings:"tnum";}.v-tnum-off{font-feature-settings:"tnum" 0;}.v-afrc{font-feature-settings:"afrc";}.v-afrc-off{font-feature-settings:"afrc" 0;}.v-frac{font-feature-settings:"frac";}.v-frac-off{font-feature-settings:"frac" 0;}</style></div><div><style>@import url('https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap');.ff-fira-sanssans-serif.cap, .ff-fira-sanssans-serif .cap {line-height: 1;} .ff-fira-sanssans-serif.cap> .t, .ff-fira-sanssans-serif .cap > .t {vertical-align: 0;line-height: 1;}.max-width-800{
  max-width: 800px;
}.bg-54-54-70-255{
  background-color: rgba(54,54,70,1);
}.fc-224-224-224-255{
  color: rgba(224,224,224,1);
}.font-size-35{
  font-size: 35px;
}.font-size-40{
  font-size: 40px;
}.spacing-20-20.r > .s + .s{
  margin-left: 20px;
}.spacing-20-20.wrp.r > .s{
  margin: 10px 10px;
}.spacing-20-20.c > .s + .s{
  margin-top: 20px;
}.spacing-20-20.pg > .s + .s{
  margin-top: 20px;
}.spacing-20-20.pg > .al{
  margin-right: 20px;
}.spacing-20-20.pg > .ar{
  margin-left: 20px;
}.spacing-20-20.p{
  line-height: calc(1em + 20px);
}textarea.s.spacing-20-20{
  line-height: calc(1em + 20px);
  height: calc(100% + 20px);
}.spacing-20-20.p > .al{
  margin-right: 20px;
}.spacing-20-20.p > .ar{
  margin-left: 20px;
}.spacing-20-20.p::after{
  content: '';
  display: block;
  height: 0;
  width: 0;
  margin-top: -10px;
}.spacing-20-20.p::before{
  content: '';
  display: block;
  height: 0;
  width: 0;
  margin-bottom: -10px;
}.height-px-33px{
  height : 33px;
}.width-px-33{
  width: 33px;
}.fc-128-128-128-255{
  color: rgba(128,128,128,1);
}.spacing-5-5.r > .s + .s{
  margin-left: 5px;
}.spacing-5-5.wrp.r > .s{
  margin: 2.5px 2.5px;
}.spacing-5-5.c > .s + .s{
  margin-top: 5px;
}.spacing-5-5.pg > .s + .s{
  margin-top: 5px;
}.spacing-5-5.pg > .al{
  margin-right: 5px;
}.spacing-5-5.pg > .ar{
  margin-left: 5px;
}.spacing-5-5.p{
  line-height: calc(1em + 5px);
}textarea.s.spacing-5-5{
  line-height: calc(1em + 5px);
  height: calc(100% + 5px);
}.spacing-5-5.p > .al{
  margin-right: 5px;
}.spacing-5-5.p > .ar{
  margin-left: 5px;
}.spacing-5-5.p::after{
  content: '';
  display: block;
  height: 0;
  width: 0;
  margin-top: -2px;
}.spacing-5-5.p::before{
  content: '';
  display: block;
  height: 0;
  width: 0;
  margin-bottom: -2px;
}.spacing-30-30.r > .s + .s{
  margin-left: 30px;
}.spacing-30-30.wrp.r > .s{
  margin: 15px 15px;
}.spacing-30-30.c > .s + .s{
  margin-top: 30px;
}.spacing-30-30.pg > .s + .s{
  margin-top: 30px;
}.spacing-30-30.pg > .al{
  margin-right: 30px;
}.spacing-30-30.pg > .ar{
  margin-left: 30px;
}.spacing-30-30.p{
  line-height: calc(1em + 30px);
}textarea.s.spacing-30-30{
  line-height: calc(1em + 30px);
  height: calc(100% + 30px);
}.spacing-30-30.p > .al{
  margin-right: 30px;
}.spacing-30-30.p > .ar{
  margin-left: 30px;
}.spacing-30-30.p::after{
  content: '';
  display: block;
  height: 0;
  width: 0;
  margin-top: -15px;
}.spacing-30-30.p::before{
  content: '';
  display: block;
  height: 0;
  width: 0;
  margin-bottom: -15px;
}.max-width-0{
  max-width: 0px;
}.p-30{
  padding: 30px 30px 30px 30px;
}.ff-fira-sanssans-serif{
  font-family: "Fira Sans", sans-serif;
  font-feature-settings: ;
  font-variant: normal;
}.fc-255-255-255-255{
  color: rgba(255,255,255,1);
}.bg-34-44-60-255{
  background-color: rgba(34,44,60,1);
}.focus-within:focus-within{
  box-shadow: 0px 0px 0px 3px rgba(155,203,255,1);
  outline: none;
}.s:focus .focusable, .s.focusable:focus, .ui-slide-bar:focus + .s .focusable-thumb{
  box-shadow: 0px 0px 0px 3px rgba(155,203,255,1);
  outline: none;
}</style></div><div class="hc ah cx spacing-30-30 s c wc ct cl"><nav class="hc font-size-20 ah cx spacing-5-5 s r wc cl ccy"><div class="hc fc-128-128-128-255 s e wc"><div class="s t wf hf">Home</div></div><div class="s t wc hc">|</div><a class="hc s e wc ccx ccy lnk" href="/projects" rel="noopener noreferrer"><div class="s t wf hf">Dev</div></a><div class="s t wc hc">|</div><a class="hc s e wc ccx ccy lnk" href="/blog" rel="noopener noreferrer"><div class="s t wf hf">Blog</div></a></nav><div class="hc ah cx spacing-30-30 s c max-width-0 wf ct cl"><a class="hc ah cx s e wc ccx ccy lnk" href="/projects" rel="noopener noreferrer"><div class="we width-px-33 he height-px-33px s e ic"><img class="we width-px-33 he height-px-33px s e" alt="Back" src="../assets/images/dark/backarrow.png"></div></a><div class="hc ah cx spacing-20-20 s c max-width-0 wf ct cl"><div class="hc w7 font-size-40 s e wc"><div class="spacing-5-5 s p wf"><div class="s t wc hc">Migrating my Golang Bot to Google Cloud Run</div></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Prior to this, I had hosted my Telegram Bot on Google Cloud App Engine, and this had worked decently well - for years, I might add - until recently I did a routine check on my bill statements and discovered that I had a $3 charge from Google.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Now, $3 isn&#039;t a lot, and it wasn&#039;t a problem for me to pay for it, but the fact that my bot&#039;s usage of compute power had broken the free barrier for the first time in years was either a very happy thing, or a troubling one.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Turns out, it was the latter.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">I was getting a failing request that would repeat every 5 minutes, and while this wasn&#039;t enough to bring down the service, it was certainly enough to cost more in terms of compute time.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">After some discussion with a friend, I decided that I should do two things:</div></div><div class="hc p-15 s c wc ct cl"><div class="spacing-5-5 s p wf"><div class="s t wc hc">1. </div><div class="s t wc hc">Fix the failing request, which would prevent this repeated message issue</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">2. </div><div class="s t wc hc">Migrate to Google Cloud Run, which would reduce cost if it did re-occur</div></div></div><div class="hc w6 font-size-35 s e wc"><div class="spacing-5-5 s p wf"><div class="s t wc hc">1. Go Modules</div></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">My last update to this repository had been a few years ago, when Go had not yet developed a mature package ecosystem (even now this seems contentious).</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">But since I wanted to containerize it, it was useful to also use a package management system rather than pulling the latest github repository of any dependency I wanted. If nothing else, this allowed me to selectively update dependencies, or freeze them to prevent any deployment surprises.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">A quick </div><div class="spacing-5-5 fc-224-224-224-255 s p wf"><code class="elmsh"><span class="elmsh5 elmsh-elm-f">go</span> mod init</code></div><div class="s t wc hc"> followed by </div><div class="spacing-5-5 fc-224-224-224-255 s p wf"><code class="elmsh"><span class="elmsh5 elmsh-elm-f">go</span> mod tidy</code></div><div class="s t wc hc"> sufficed.</div></div><div class="hc w6 font-size-35 s e wc"><div class="spacing-5-5 s p wf"><div class="s t wc hc">2. Containerization</div></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Google Cloud Run uses containers to spin up a serverless instance, which then dies after the request has been handled. As such, I needed to containerize my solution - i.e. Dockerize.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Using a template for a Go module deployment, I modified the necessary files and built the container with little issue.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">I had to do a little trick to include my secrets file into the image, which was just to copy the </div><div class="spacing-5-5 fc-224-224-224-255 s p wf"><code class="elmsh"><span class="elmsh5 elmsh-elm-f">secrets</span><span class="elmsh1 elmsh-elm-n">.</span>yaml</code></div><div class="s t wc hc"> from the build directory into the container, and then deploy the container.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Since I never pushed the </div><div class="spacing-5-5 fc-224-224-224-255 s p wf"><code class="elmsh"><span class="elmsh5 elmsh-elm-f">secrets</span><span class="elmsh1 elmsh-elm-n">.</span>yaml</code></div><div class="s t wc hc"> to Github, this was technically pretty safe, and I was okay with this approach so far.</div></div><div class="hc w6 font-size-35 s e wc"><div class="spacing-5-5 s p wf"><div class="s t wc hc">3. Google Artifact Registry</div></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">I didn&#039;t have GCloud CLI on my device, so I had to get that installed and set up.</div></div><div class="hc ah cx bg-54-54-70-255 p-10 s e max-width-800 wf"><div class="hc s r wc cl ccy wrp"><code class="elmsh"><span class="elmsh5 elmsh-elm-f">gcloud</span> config set project <span class="elmsh3 elmsh-elm-bs">$</span><span class="elmsh4 elmsh-elm-gs">{</span><span class="elmsh6 elmsh-elm-c">PROJECT_NAME</span><span class="elmsh4 elmsh-elm-gs">}</span>

<span class="elmsh5 elmsh-elm-f">echo</span> <span class="elmsh3 elmsh-elm-bs">$</span><span class="elmsh6 elmsh-elm-c">CI_SERVICE_KEY</span> <span class="elmsh3 elmsh-elm-bs">&gt;</span> key<span class="elmsh1 elmsh-elm-n">.</span>json

<span class="elmsh5 elmsh-elm-f">gcloud</span> auth activate<span class="elmsh3 elmsh-elm-bs">-</span>service<span class="elmsh3 elmsh-elm-bs">-</span>account <span class="elmsh3 elmsh-elm-bs">\</span>
  <span class="elmsh3 elmsh-elm-bs">$</span><span class="elmsh6 elmsh-elm-c">CI_SERVICE_ACCOUNT</span> <span class="elmsh-comm">--key-file=key.json</span>
  
<span class="elmsh5 elmsh-elm-f">gcloud</span> auth configure<span class="elmsh3 elmsh-elm-bs">-</span>docker <span class="elmsh3 elmsh-elm-bs">\</span>
  <span class="elmsh2 elmsh-elm-s">&quot;${ARTIFACT_REGISTRY_REGION}-docker.pkg.dev&quot;</span> 
</code></div></div><div class="spacing-5-5 s p wf"><div class="s e max-width-800 wf ic"><img class="s e max-width-800 wf" alt="Service_Accounts.png" src="../assets/blog/2022_01_07_Golang_Bot_Cloud_Run/Service_Accounts.png"></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">This wasn&#039;t too difficult. I had to create a service account on GCloud and prepare the key, and I was able to authenticate Docker on my machine against Google Artifact Registry.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Building and pushing the container was also not difficult manually.</div></div><div class="hc ah cx bg-54-54-70-255 p-10 s e max-width-800 wf"><div class="hc s r wc cl ccy wrp"><code class="elmsh"><span class="elmsh5 elmsh-elm-f">docker</span> build <span class="elmsh3 elmsh-elm-bs">-</span>f <span class="elmsh6 elmsh-elm-c">Dockerfile</span> <span class="elmsh3 elmsh-elm-bs">-</span>t <span class="elmsh3 elmsh-elm-bs">$</span><span class="elmsh6 elmsh-elm-c">CONTAINER_IMAGE</span>  <span class="elmsh1 elmsh-elm-n">.</span>

<span class="elmsh5 elmsh-elm-f">docker</span> push <span class="elmsh3 elmsh-elm-bs">$</span><span class="elmsh6 elmsh-elm-c">CONTAINER_IMAGE</span>

<span class="elmsh5 elmsh-elm-f">gcloud</span> run deploy <span class="elmsh3 elmsh-elm-bs">$</span><span class="elmsh6 elmsh-elm-c">CLOUD_RUN_SERVICE_NAME</span> <span class="elmsh3 elmsh-elm-bs">\</span>
  <span class="elmsh-comm">--image $CONTAINER_IMAGE \</span>
  <span class="elmsh-comm">--region $CLOUD_RUN_SERVICE_REGION</span>
</code></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">It was pretty easy to verify these processes succeeded, just by checking the Artifact Registry and Cloud Run panels respectively.</div></div><div class="spacing-5-5 s p wf"><div class="s e max-width-800 wf ic"><img class="s e max-width-800 wf" alt="Artifact_Registry.png" src="../assets/blog/2022_01_07_Golang_Bot_Cloud_Run/Artifact_Registry.png"></div><div class="s t wc hc">
</div><div class="s e max-width-800 wf ic"><img class="s e max-width-800 wf" alt="Cloud_Run.png" src="../assets/blog/2022_01_07_Golang_Bot_Cloud_Run/Cloud_Run.png"></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Up to this point, I was able to manage quite decently, and the immediate issue was fixed within the day.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">I retired the old AppEngine version of the service, and moved on.</div></div><div class="hc w6 font-size-35 s e wc"><div class="spacing-5-5 s p wf"><div class="s t wc hc">4. CI/CD with Github Actions</div></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Up to this point I was able to ensure security by basically running this whole process only on an authenticated device; i.e. my laptop. I needed to authenticate Github Actions to do the same thing.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">I quickly discovered that Github Actions did not have the same idea of &#039;secure&#039; that I did. It took me awhile and a lot of experimentation to figure that I not only needed to have the Service Account, but also...</div></div><div class="hc p-15 s c wc ct cl"><div class="spacing-5-5 s p wf"><div class="s t wc hc">1. </div><div class="s t wc hc">To set up GCloud Auth on the project</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">2. </div><div class="s t wc hc">A step which I forgot, and which cost me a couple of days of debugging - to authenticate Docker with GCloud Auth</div></div></div><div class="spacing-5-5 s p wf"><div class="s e max-width-800 wf ic"><img class="s e max-width-800 wf" alt="Github_Actions.png" src="../assets/blog/2022_01_07_Golang_Bot_Cloud_Run/Github_Actions.png"></div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">In the process of debugging, I also went ahead and upgraded my security method to use Google Auth&#039;s Workload Identity Federation, following </div><a class="hc s e wc ccx ccy lnk" href="https://cloud.google.com/blog/products/identity-security/enabling-keyless-authentication-from-github-actions" rel="noopener noreferrer"><div class="spacing-5-5 s p wf"><div class="s t wc hc">this post</div></div></a><div class="s t wc hc">.</div></div><div class="spacing-5-5 s p wf"><div class="s t wc hc">Once those were done, it was a pretty simple process to serialize the secrets from Github Actions into the docker container, and then to run the same steps as above from Github Actions.</div></div></div></div><div class="hc ah cx spacing-30-30 s r wc cl ccy"><a class="hc s e wc ccx ccy lnk" href="https://github.com/julwrites" rel="noopener noreferrer"><div class="we width-px-33 he height-px-33px s e ic"><img class="we width-px-33 he height-px-33px s e" alt="Github" src="assets/images/dark/github.png"></div></a><a class="hc s e wc ccx ccy lnk" href="https://linkedin.com/in/julwrites" rel="noopener noreferrer"><div class="we width-px-33 he height-px-33px s e ic"><img class="we width-px-33 he height-px-33px s e" alt="LinkedIn" src="assets/images/dark/linkedin.png"></div></a><a class="hc s e wc ccx ccy lnk" href="mail@tehj.io" rel="noopener noreferrer"><div class="we width-px-33 he height-px-33px s e ic"><img class="we width-px-33 he height-px-33px s e" alt="Email" src="assets/images/dark/email.png"></div></a><a class="hc s e wc ccx ccy" download="" href="assets/resume/Resume_Julian_Teh.pdf"><a class="hc s e wc ccx ccy lnk" href="assets/resume/Resume_Julian_Teh.pdf" rel="noopener noreferrer"><div class="we width-px-33 he height-px-33px s e ic"><img class="we width-px-33 he height-px-33px s e" alt="Resume" src="assets/images/dark/download.png"></div></a></a></div></div></div>
    </body>
  </html>
  